events {
}


map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;

    listen [::]:80;

    server_name smilebat.xyz www.smilebat.xyz;

    location / {
        proxy_pass http://38.242.132.44:8080/auth/login;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect http://38.242.132.44:8080/auth/login $scheme://$http_host/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 20d;
        proxy_buffering off;

    }
    location /auth {
        proxy_pass http://38.242.132.44:8085/auth;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect http://38.242.132.44:8085/auth $scheme://$http_host/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 20d;
        proxy_buffering off;

    }

    location /auth/realms {
        proxy_pass http://38.242.132.44:8085/auth/realms;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect http://38.242.132.44:8085/auth/realms $scheme://$http_host/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 20d;
        proxy_buffering off;

    }

    location /swagger {
        proxy_pass http://38.242.132.44:8089/swagger-ui.html;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect http://38.242.132.44:8089/swagger-ui.html $scheme://$http_host/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 20d;
        proxy_buffering off;

    }
    location /api/v1 {
        proxy_pass http://38.242.132.44:8089/api/v1;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect http://38.242.132.44:8089/api/v1 $scheme://$http_host/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 20d;
        proxy_buffering off;

    }
    location /auth/token {
        proxy_pass http://38.242.132.44:8080;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect http://38.242.132.44:8080 $scheme://$http_host/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_read_timeout 20d;
        proxy_buffering off;

    }

}


server {

    listen 8080;
    listen [::]:8080;

    #server_name smilebat.xyz www.smilebat.xyz;

    root /opt/nginx/html;
    resolver 127.0.0.11 valid=1s ipv6=off;
    
    location / {
        access_by_lua_block {
            local opts = {
                redirect_uri = 'http://localhost:3000/smile-bat/dashboard',
                accept_none_alg = true,
                discovery = 'http://host.docker.internal:8085/realms/master/.well-known/openid-configuration',
                client_id = 'nginx',
                client_secret = 'bP9zTt7zArJBbIYwmFCE2AiyzFTD1Ppo',
                redirect_uri_scheme = 'http',
                logout_path = '/logout',
                redirect_after_logout_uri = 'http://host.docker.internal:8085/realms/master/protocol/openid-connect/logout?redirect_uri=http://localhost:3000/smile-bat/dashboard',
                redirect_after_logout_with_id_token_hint = false,
                session_contents = {
                    id_token=true
                }
            }
            local res, err = require('resty.openidc').authenticate(opts)
            if err then
            ngx.status = 403
            ngx.say(err)
            ngx.exit(ngx.HTTP_FORBIDDEN)
            end
        }
    }

    # Disabled caching so the browser won't cache the site.
    expires 0;
    add_header Cache-Control private;

    # redirect server error pages to the static page /40x.html
    #
    error_page 404 /404.html;
    location = /40x.html {
    }

    # redirect server error pages to the static page /50x.html
    #
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    }


}
